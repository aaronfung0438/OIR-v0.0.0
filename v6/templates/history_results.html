{% extends "base.html" %}

{% block title %}{{ get_text('history_search') }} - {{ get_text('title') }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-search-plus me-2"></i>{{ 'Search Results' if current_lang == 'en' else '搜尋結果' if current_lang == 'zh-TW' else '搜索结果' }}
                    </h4>
                    <span class="badge bg-light text-dark">
                        {{ results | length }} {{ 'records found' if current_lang == 'en' else '筆記錄' if current_lang == 'zh-TW' else '条记录' }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Search Filters Summary -->
                {% if filters %}
                <div class="alert alert-light mb-4">
                    <h6>{{ 'Applied Filters:' if current_lang == 'en' else '已套用篩選：' if current_lang == 'zh-TW' else '已应用筛选：' }}</h6>
                    <div class="d-flex flex-wrap gap-2">
                        {% if filters.date_from %}
                        <span class="badge bg-secondary">{{ get_text('date_from') }}: {{ filters.date_from }}</span>
                        {% endif %}
                        {% if filters.date_to %}
                        <span class="badge bg-secondary">{{ get_text('date_to') }}: {{ filters.date_to }}</span>
                        {% endif %}
                        {% if filters.model_no %}
                        <span class="badge bg-secondary">{{ get_text('model_no') }}: {{ filters.model_no }}</span>
                        {% endif %}
                        {% if filters.lot_no %}
                        <span class="badge bg-secondary">{{ get_text('lot_no') }}: {{ filters.lot_no }}</span>
                        {% endif %}
                        {% if filters.operator %}
                        <span class="badge bg-secondary">{{ get_text('operator') }}: {{ filters.operator }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Results Table -->
                {% if results %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="resultsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                </th>
                                <th>{{ get_text('date') }}</th>
                                <th>{{ get_text('model_no') }}</th>
                                <th>{{ 'Model Description' if current_lang == 'en' else '型號描述' if current_lang == 'zh-TW' else '型号描述' }}</th>
                                <th>{{ get_text('ois_no') }}</th>
                                <th>{{ get_text('lot_no') }}</th>
                                <th>{{ get_text('item') }}</th>
                                <th>{{ get_text('operator') }}</th>
                                <th>{{ 'Data Count' if current_lang == 'en' else '數據數量' if current_lang == 'zh-TW' else '数据数量' }}</th>
                                <th>{{ 'Actions' if current_lang == 'en' else '操作' if current_lang == 'zh-TW' else '操作' }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>
                                    <input type="checkbox" class="row-checkbox" value="{{ loop.index0 }}" onchange="updateGenerateButton()">
                                </td>
                                <td>{{ result.Date if result.Date else '-' }}</td>
                                <td><strong>{{ result['Model No.'] or '-' }}</strong></td>
                                <td>{{ result['Model Description'] or '-' }}</td>
                                <td>{{ result['OIS No.'] or '-' }}</td>
                                <td>{{ result['Lot No.'] or '-' }}</td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{{ result.Item or '-' }}</span>
                                </td>
                                <td>{{ result.Operator or '-' }}</td>
                                <td class="text-center">
                                    {% set data_count = 0 %}
                                    {% for i in range(1, 11) %}
                                        {% if result['Datapoint_' + i|string] is not none %}
                                            {% set data_count = data_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="badge bg-success">{{ data_count }}/10</span>
                                </td>
                                <td>
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary" 
                                            onclick="viewDetails({{ loop.index0 }})"
                                            data-bs-toggle="modal" 
                                            data-bs-target="#detailModal">
                                        <i class="fas fa-eye me-1"></i>{{ 'View' if current_lang == 'en' else '檢視' if current_lang == 'zh-TW' else '查看' }}
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-search text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 text-muted">{{ get_text('no_results') }}</h5>
                    <p class="text-muted">{{ 'Try adjusting your search criteria' if current_lang == 'en' else '請調整搜尋條件' if current_lang == 'zh-TW' else '请调整搜索条件' }}</p>
                </div>
                {% endif %}

                <!-- Action Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('history_report') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>{{ 'New Search' if current_lang == 'en' else '新搜尋' if current_lang == 'zh-TW' else '新搜索' }}
                    </a>
                    {% if results %}
                    <div>
                        <button type="button" id="generateExcelBtn" class="btn btn-success" onclick="generateSelectedReports()" disabled>
                            <i class="fas fa-file-excel me-2"></i>{{ 'Generate Excel' if current_lang == 'en' else '生成Excel' if current_lang == 'zh-TW' else '生成Excel' }}
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ 'Record Details' if current_lang == 'en' else '記錄詳情' if current_lang == 'zh-TW' else '记录详情' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ 'Close' if current_lang == 'en' else '關閉' if current_lang == 'zh-TW' else '关闭' }}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Store results data for JavaScript access
const resultsData = {{ results | tojson }};

function viewDetails(index) {
    const record = resultsData[index];
    
    let content = `
        <div class="row">
            <div class="col-md-6">
                <h6>{{ 'Basic Information' if current_lang == 'en' else '基本資訊' if current_lang == 'zh-TW' else '基本信息' }}</h6>
                <table class="table table-sm">
                    <tr><td><strong>{{ get_text('date') }}:</strong></td><td>${record.Date || '-'}</td></tr>
                    <tr><td><strong>{{ get_text('model_no') }}:</strong></td><td>${record['Model No.'] || '-'}</td></tr>
                    <tr><td><strong>{{ get_text('ois_no') }}:</strong></td><td>${record['OIS No.'] || '-'}</td></tr>
                    <tr><td><strong>{{ get_text('lot_no') }}:</strong></td><td>${record['Lot No.'] || '-'}</td></tr>
                    <tr><td><strong>{{ get_text('operator') }}:</strong></td><td>${record.Operator || '-'}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>{{ 'Data Points' if current_lang == 'en' else '數據點' if current_lang == 'zh-TW' else '数据点' }}</h6>
                <div class="d-flex flex-wrap gap-1">
    `;
    
    for (let i = 1; i <= 10; i++) {
        const value = record[`Datapoint_${i}`];
        if (value !== null && value !== undefined) {
            content += `<span class="badge bg-primary">${i}: ${value}</span>`;
        } else {
            content += `<span class="badge bg-light text-dark">${i}: -</span>`;
        }
    }
    
    content += `
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modalContent').innerHTML = content;
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    
    rowCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
    });
    
    updateGenerateButton();
}

function updateGenerateButton() {
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    const generateBtn = document.getElementById('generateExcelBtn');
    
    // Enable button only if at least one row is selected
    generateBtn.disabled = checkedBoxes.length === 0;
    
    // Update select all checkbox state
    const selectAllCheckbox = document.getElementById('selectAll');
    if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedBoxes.length === rowCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
    }
}

function generateSelectedReports() {
    const checkedBoxes = document.querySelectorAll('.row-checkbox:checked');
    
    if (checkedBoxes.length === 0) {
        alert('{{ "Please select at least one record" if current_lang == "en" else "請至少選擇一筆記錄" if current_lang == "zh-TW" else "请至少选择一条记录" }}');
        return;
    }
    
    const selectedRecords = [];
    checkedBoxes.forEach(checkbox => {
        const index = parseInt(checkbox.value);
        selectedRecords.push(resultsData[index]);
    });
    
    // Show loading indicator
    const button = document.getElementById('generateExcelBtn');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>{{ "Generating..." if current_lang == "en" else "生成中..." if current_lang == "zh-TW" else "生成中..." }}';
    button.disabled = true;
    
    // Make AJAX call to prepare report generation (first step)
    fetch('{{ url_for("prepare_history_report") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            records: selectedRecords,
            multiple: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Redirect to additional info page
            window.location.href = data.redirect_url;
        } else {
            alert('{{ "Error" if current_lang == "en" else "錯誤" if current_lang == "zh-TW" else "错误" }}: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('{{ "Report generation failed" if current_lang == "en" else "報告生成失敗" if current_lang == "zh-TW" else "报告生成失败" }}');
    })
    .finally(() => {
        // Restore button
        button.innerHTML = originalText;
        updateGenerateButton(); // This will re-enable if records are still selected
    });
}

// Initialize DataTable if available
$(document).ready(function() {
    if ($.fn.DataTable && $('#resultsTable').length) {
        $('#resultsTable').DataTable({
            pageLength: 25,
            order: [[0, 'desc']], // Sort by date descending
            language: {
                search: '{{ "Search:" if current_lang == "en" else "搜尋：" if current_lang == "zh-TW" else "搜索：" }}',
                lengthMenu: '{{ "Show _MENU_ entries" if current_lang == "en" else "顯示 _MENU_ 筆" if current_lang == "zh-TW" else "显示 _MENU_ 条" }}',
                info: '{{ "Showing _START_ to _END_ of _TOTAL_ entries" if current_lang == "en" else "顯示第 _START_ 至 _END_ 筆，共 _TOTAL_ 筆" if current_lang == "zh-TW" else "显示第 _START_ 至 _END_ 条，共 _TOTAL_ 条" }}',
                paginate: {
                    first: '{{ "First" if current_lang == "en" else "首頁" if current_lang == "zh-TW" else "首页" }}',
                    last: '{{ "Last" if current_lang == "en" else "末頁" if current_lang == "zh-TW" else "末页" }}',
                    next: '{{ "Next" if current_lang == "en" else "下一頁" if current_lang == "zh-TW" else "下一页" }}',
                    previous: '{{ "Previous" if current_lang == "en" else "上一頁" if current_lang == "zh-TW" else "上一页" }}'
                }
            }
        });
    }
});
</script>
{% endblock %}

